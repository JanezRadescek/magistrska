\section{Račun \lae{}}\label{sec:lae}

Račun $\lambda$ je preprost teoretičen programski jezik. Leta 1930 ga je uvedel Alonzo Chuch z namenom formalizacije koncepta izračunljivosti~\cite{rojas2015tutorial}. Račun lambda je Turingovo poln.


Račun \lae{} je razširitev računa $\lambda$. Posledično je tudi \lae{}-račun Turingovo poln. Računu \lae{} dodamo izraze, ki poosebijo bistvo asinhrono vzporednega programiranja z pomočjo učinkov. Da \lae{}-račun čim bolj približamo vsakdanjim programskim jezikom, mu dodamo tudi izraze za  naravna števila, par, ujemanje vzorca...


\subsection{Izrazi}

Izraze v \lae{}-računu razdelimo na vrednosti, izračune in procese. 


Vrednosti so sledeče.
Konstante vrednosti naravna števila in logični vrednosti resnica in neresnica.
Spremenljivke, ki so simbolična imena povezana z vrednostmi v danem kontekstu.
Enote in pare.
leve in desne inkluzije vsote.
Lambda abstrakcije.
Rekurzivne lambda abstrakcije.
Izpolnjena obljuba. Ta vrednost je edina zares nova. Je vrednost, ki jo je vrnil prestreznik in jo posebej označimo, da bomo kasneje lahko pravilno določili tip.


Izračuni so sledeči.
Vrni ki drži neko vrednost.
Zaporedje dveh izračunov.
Aplikacija ki v prvi izraz substituira drugi izraz.
Ujemanje ki glede na vzorec izraza izbere izračun. 
Signal vsebuje operacijo, pripadajočo vrednost imenovano tovor in izračun.
Prekinitev vsebuje operacijo, pripadajočo vrednost imenovano tovor in izračun.
Prestreznik vsebuje ime operacije, ime spremeljivke, Izračun M in izračun N.
blokada


Pripadajočo sintakso vidimo na sliki~\ref{fig:izrazi} v Backus-Naurjevi obliki (BNF).



\begin{figure}[H]
	\parbox{\textwidth}{
		\centering
		\small
		\begin{align*}
		\intertext{\textbf{Vrednosti}}
		V, W
		\bnfis& n \bnfor\! \true \bnfor\! \false        & &\text{konstantne vrednosti} \\
		\bnfor& x                                       & &\text{spremenljivka} \\
		\bnfor& \tmunit \bnfor\! \tmpair{V}{W}          & &\text{enota in par} \\
		\bnfor& \tminl[Y]{V} \bnfor\! \tminr[X]{V}      & &\text{leva in desna inkluzija} \\
		\bnfor& \tmfun{x}{M}                        & &\text{lambda} \\
		\bnfor& \tmfunrec{f}{x : X}{M}                        & &\text{rekurzivna lambda} \\
		\bnfor& \tmpromise V                            & &\text{izpolnjena obljuba}
		\\[1ex]
		\intertext{\textbf{Izračuni}}
		M, N
		\bnfis& \tmreturn{V}                            & &\text{vrnjena vrednost} \\
		\bnfor& \tmlet{x}{M}{N}                         & &\text{zaporedje} \\
	%	\bnfor& \tmletrec[: \tyfun{X}{Y}]{f}{x}{M}{N} & &\text{rekurzivna definicija} \\
		\bnfor& V\,W                                    & &\text{aplikacija} \\
		\bnfor& \tmmatch{V}{\tmpair{x}{y} \mapsto M}    & &\text{ujemanje produkta} \\
		\bnfor& \tmmatch[]{V}{}                        & &\text{prazno ujemanje} \\
		\bnfor& \tmmatch{V}{\tminl{x} \mapsto M, \tminr{y} \mapsto N}	& &\text{ujemanje vsote} \\
		\bnfor& \tmopout{op}{V}{M}       & &\text{signal} \\
		\bnfor& \tmopin{op}{V}{M}          & &\text{prekinitev} \\
		\bnfor& \tmwith{op}{x}{M}{p}{N}      & &\text{prestreznik} \\
		\bnfor& \tmawait{V}{x}{M}             & &\text{blokada}
			\\[1ex]
		\intertext{\textbf{Procesi}}
	%	P \bnfis & ...
		  P, Q
		\bnfis & \tmrun M & & \text{run} \\
		\bnfor & \tmpar P Q & & \text{vzporedna procesa} \\
		\bnfor & \tmopout{op}{V}{P} & & \text{proces signal} \\
		\bnfor & \tmopin{op}{V}{P} & & \text{proces prekinitev}
		\end{align*}
	} 
	\caption{Vrednosti, izračuni in procesi.}
	\label{fig:izrazi}
\end{figure}


\subsection{Operacijska semantika}

\jR{Dodaj definicijo substitucije}

Račun \lae\ opremimo z operacijsko semantiko malih korakov, ki je definirana z relacijo korak $M \reduces N$. Redukcijska pravila za izračune so podana na sliki~\ref{fig:small-step-semantics-of-computations}. Redukcijska pravila za procese so podana na sliki~\ref{fig:small-step-semantics-of-processes}.

\begin{figure}[H]
	\centering
	\small
	\begin{align*}
	\intertext{\textbf{Pravila osnovnih izračunov}}
	\tmapp{(\tmfun{x \of X}{M})}{V} &\reduces M[V/x]
	\\
	\tmapp{(\tmfunrec{f}{x \of X}{M})}{V} &\reduces M[V/x, (\tmfunrec{f}{x \of X}{M})/f]
	\\
	\tmlet{x}{(\tmreturn V)}{N} &\reduces N[V/x]
	\\
	\tmmatch{\tmpair{V}{W}}{\tmpair{x}{y} \mapsto M} &\reduces M[V/x, W/y]
	\\
	\mathllap{\tmmatch{(\tminl[Y]{V})}{\tminl{x} \mapsto M, \tminr{y} \mapsto N}} &\reduces	M[V/x]
	\\
	\mathllap{\tmmatch{(\tminr[X]{W})}{\tminl{x} \mapsto M, \tminr{y} \mapsto N}} &\reduces	N[W/y]
	\\[1ex]
	\intertext{\textbf{Algebraičnost signala in prestreznika}}
	\tmlet{x}{(\tmopout{op}{V}{M})}{N} &\reduces \tmopout{op}{V}{\tmlet{x}{M}{N}}
	\\
	\tmlet{x}{(\tmwith{op}{y}{M}{p}{N_1})}{N_2} &\reduces \tmwith{op}{y}{M}{p}{(\tmlet{x}{N_1}{N_2})}
	\\[1ex]
	\intertext{\textbf{Komutativnost operacij}}
	\tmwith{op}{x}{M}{p}{\tmopout{op'}{V}{N}} &\reduces \tmopout{op'}{V}{\tmwith{op}{x}{M}{p}{N}}
	\\
	\tmopin{op}{V}{\tmopout{op'}{W}{M}} &\reduces \tmopout{op'}{W}{\tmopin{op}{V}{M}}
	\\[1ex]
	\intertext{\textbf{Širitev prekinitve}}
	\tmopin{op}{V}{\tmreturn W} &\reduces \tmreturn W
	\\
	\tmopin{op}{V}{\tmwith{op}{x}{M}{p}{N}} &\reduces \tmlet{p}{M[V/x]}{\tmopin{op}{V}{N}}
	\\
	\tmopin{op'}{V}{\tmwith{op}{x}{M}{p}{N}} &\reduces \tmwith{op}{x}{M}{p}{\tmopin{op'}{V}{N}} \\
	&\qquad {\color{rulenameColor}(\op \neq \op')}
	\\[1ex]
	\intertext{\textbf{Čakanje na izpolnitev obljube}}
	\tmawait{\tmpromise V}{x}{M} &\reduces M[V/x]
	\\[-8ex]
	\end{align*}
	
	\begin{align*}
	\intertext{\textbf{Evalvacija v okolju}}
	\coopinfer{}{
		N \reduces N'
	}{
		M[N] \reduces M[N']
	}
	\end{align*}
	\vspace{-6ex}
	\begin{align*}
	\intertext{\textbf{kjer}}
	\text{$M[N]$}
	\bnfis & \tmlet{x}{N}{N''}
	\\
	\bnfor & \tmopout{op}{V}{N}
	\\
	\bnfor & \tmopin{op}{V}{N} 
	\\
	\bnfor & \tmwith{op}{x}{N''}{p}{N}
	\end{align*}
	
	\caption{Redukcijska pravila za izračune.}
	\label{fig:small-step-semantics-of-computations}
\end{figure}

\begin{figure}[H]
    \centering
	\small
	\begin{minipage}[t]{0.4\textwidth}
		\centering
		\begin{align*}
		\intertext{\textbf{Posamezen proces}}
		\coopinfer{}{
			M \reduces N
		}{
			\tmrun M \reduces \tmrun N
		}
		\end{align*}
	\end{minipage}
	\qquad
	\begin{align*}
	\intertext{\textbf{Prehod}}
	\tmrun {(\tmopout{op}{V}{M})}  &\reduces \tmopout{op}{V}{\tmrun M}
	\\
	\tmopin{op}{V}{\tmrun M} &\reduces \tmrun {(\tmopin{op}{V}{M})}
	\\[1ex]
	\intertext{\textbf{Oddajanje signala}}
	\tmpar{\tmopout{op}{V}{P}}{Q} &\reduces \tmopout{op}{V}{\tmpar{P}{\tmopin{op}{V}{Q}}}
	\\
	\tmpar{P}{\tmopout{op}{V}{Q}} &\reduces \tmopout{op}{V}{\tmpar{\tmopin{op}{V}{P}}{Q}}
	\\[1ex]
	\intertext{\textbf{Širitev prekinitve}}
	\tmopin{op}{V}{\tmpar P Q} &\reduces \tmpar {\tmopin{op}{V}{P}} {\tmopin{op}{V}{Q}}
	\\[1ex]
	\intertext{\textbf{Komutativnost signala in prekinitve}}
	\tmopin{op}{V}{\tmopout{op'}{W}{P}} &\reduces \tmopout{op'}{W}{\tmopin{op}{V}{P}}
	\end{align*}
	\vspace{-4ex}
	\begin{align*}
	\shortintertext{\quad\textbf{Evalvacija v okolju}}
	\quad
	\coopinfer{}{
		Q \reduces Q'
	}{
		P[Q] \reduces P[Q']
	}
	\end{align*}
	\vspace{-6ex}
	\begin{align*}
	\intertext{\textbf{kjer}}
	\text{$P[Q]$}
	\bnfis & \tmpar{Q}{Q''} 
	\\
	\bnfor & \tmpar{Q''}{Q}
	\\
	\bnfor & \tmopout{op}{V}{Q}
	\\
	\bnfor & \tmopin{op}{V}{Q}
	\end{align*}
	
	\caption{Redukcijska pravila za procese.}
	\label{fig:small-step-semantics-of-processes}
\end{figure}

Poleg teh pravil, ki so identična pravilom iz članka od Ahmana in Pretnarja~\cite{aeff}, dodamo še dve novi.
Prvo pravilo potegne blokado ven iz zaporedja. Drugo pravilo prestavi prekinitev takoj za blokado. Obe pravili skupaj dosežeta dvoje. Malenkost večji del prvotnega izračuna je postal asinhron. Kar nam lahko v primeru, da bo obljuba izpolnjena in bomo nadaljevali z izvajanjem tega dela, nekoliko pohitri izvajanje. Druga prednost pa je, da izračun, ki je v čakajočem stanju, se vedno začne z izračunom $\tmkw{Await}$. Posledično je prepoznati ali je izračun v čakajočem stanju trivialno in se bodo delni rezultati nekoliko poenostavili. 

Rezultati ostanejo enaki kot v originalnem članku~\cite{aeff}.

\begin{figure}[H]
	\centering
	\small
	\begin{align*}
		\intertext{\textbf{Algebraičnost blokade}}
		\tmlet{x}{(\tmawait{V}{y}{M})}{N} & \reduces \tmawait{V}{y}{(\tmlet{x}{M}{N})}
		\\[1ex]
		\intertext{\textbf{Komutativnost blokade in prekinitve}}
		\tmopin{op}{V}{\tmawait{W}{x}{M}} &\reduces \tmawait{W}{x}{\tmopin{op}{V}{M}}
	\end{align*}
	
	\caption{Dodatni pravili operacijske semantike.}
	\label{fig:operacijska-semantika-poenostavitev}
\end{figure}

\subsection{Sistem tipov}


Da se izognemo nekaterim napakam ob izvajanju uvedemo sistem tipov.
Tipe ločimo na tipe za vrednosti, izračune in procese.
Večina vrednosti dobi standardne tipe, kot so naravno število, boolean, enota, par, vsota in funkcijski tip. 
Ker funkcijski tip označuje funkcijo, ki vzame argument in mu priredi izračun, le tej pa imajo, kot bomo kasneje videli, poleg standardnih tipov, še tipe za učinke, ima tudi funkcijski tip dodane tipe za učinke.


Dodatno za vrednost obljuba uvedemo tip \emph{obljuba} $\typromise{A}$. 
Tipom za vrednosti, ki ne vsebujejo funkcijskega tipa ali obljube, pravimo osnovni tipi. 


Izračunom poleg standardnega tipa dodamo še tipe signalov, ki jih lahko sprožimo, označene z $\o$ in tipe prekinitev, ki jih lahko prestrežemo, označene z $\i$.
Tipi učinkov $\o$ in $\i$ so elementi množice $O$ oziroma $I$.
Množica $\sig$ je množica vseh operacij, ki jih imamo na voljo.
Množica $O$ je preprosto potenčna množica množice $\sig$ in posledično $\o$ predstavlja množico signalov, ki jih izračun lahko sproži.

Ko prestrežemo neko prekinitev lahko ustrezen izračun obljuba začne sprožati nove signale in prestrezati nove prekinitve. Zato $I$ definiramo kot največjo fiksno točko preslikave $\Omega$ definirane kot 
$$\Omega(X) = \sig \Rightarrow (O \times X)_\bot ,$$
kjer je $\Rightarrow$ potenciranje, $\times$ je kartezični produkt in $(-)_\bot$ je dvig.

...TODO

Tipi procesov so odvisni od tipov izračunov in posledično vsebujejo tipe učinkov.

Pravila za dodelitev tipa vidimo na sliki~\ref{fig:value-typing-rules} in~\ref{fig:computation-typing-rules}.


\begin{figure}[H]
	\parbox{\textwidth}{
		\centering
		\small
		\begin{align*}
		\text{Osnovni tipi vrednosti $\bar{A}$, $\bar{B}$}
		\bnfis & \tysym{int} \,\bnfor\! \tysym{bool} \,\bnfor\! \tyunit \,\bnfor\! \tyempty \,\bnfor\! \typrod{\bar{A}}{\bar{B}} \,\bnfor\! \tysum{\bar{A}}{\bar{B}}
		\\%[1ex]
		\text{Tipi vrednosti $A$, $B$}
		\bnfis & \bar{A} \, \bnfor\! \typrod{A}{B} \,\bnfor\! \tysum{A}{B} \,\bnfor\! \tyfun{A}{\tycomp{B}{\o,\i}} \,\bnfor\! \typromise{A}
		\\
		\text{Tip izračuna} \bnfis& \tycomp{A}{\o,\i}
		\\
		\text{Tip procesa \tyC, \tyD}  \bnfis & \tyrun{A}{\o, \i} \,\bnfor\! \typar{\tyC}{\tyD}
		\end{align*}
	} 
	\caption{Tipi izrazov}
	\label{fig:tipi}
\end{figure}

Vsaki operaciji priredimo nek tip, kot vidimo na sliki~\ref{fig:operacije}. Ker izračun 
$$ \tmwith{op}{x}{M}{p}{\tmopout{op'}{V}{N}} $$
lahko naredi korak v izračun
$$ \tmopout{op'}{V}{\tmwith{op}{x}{M}{p}{N}} $$,
je ključno da vrednost $V$ ne vsebuje spremenljivke $p$, saj v drugem izračunu spremenljivka $p$ v vrednosti $V$ ni več dobro definiran. Da zagotovimo, da vrednost $V$ ne vsebuje spremenljivke $p$, omejimo tipe, ki pripadajo operacijam, na osnovne tipe.

\begin{figure}[H]
	\centering
	\small
	\begin{align*}
	(op_1, \bar{A}_{op_1}),\, (op_2, \bar{A}_{op_2}),\, ... ,\, (op_n, \bar{A}_{op_k})
	\end{align*}
\vspace{-5ex}
	\caption{Operacije in pripadajoči osnovni tipi.}
	\label{fig:operacije}
\end{figure}



\begin{figure}[H]
	\centering
	\small
	\begin{mathpar}
		\quad
		\coopinfer{Ty-Var}{
		}{
			\Gamma, x \of X, \Gamma' \types x : X
		}
		\quad
		\coopinfer{Ty-Cons-N}{
		}{
			\Gamma \types n : int
		}
		\qquad
		\coopinfer{Ty-Cons-T}{
		}{
			\Gamma \types true : bool
		}
		\qquad
		\coopinfer{Ty-Cons-F}{
		}{
			\Gamma \types false : bool
		}
		\coopinfer{Ty-Unit}{
		}{
			\Gamma \types \tmunit : \tyunit
		}
		\\
		\coopinfer{Ty-Pair}{
			\Gamma \types V : X \\
			\Gamma \types W : Y
		}{
			\Gamma \types \tmpair{V}{W} : \typrod{X}{Y}
		}
		\quad
		\coopinfer{Ty-Promise}{
			\Gamma \types V : X
		}{
			\Gamma \types \tmpromise V : \typromise X
		}
		\quad
		\coopinfer{Ty-Inl}{
			\Gamma \types V : X
		}{
			\Gamma \types \tminl[Y]{V} : X + Y
		}
		\quad
		\coopinfer{Ty-Inr}{
			\Gamma \types W : Y
		}{
			\Gamma \types \tminr[X]{W} : X + Y
		}
		\\
		\coopinfer{Ty-Fun}{
			\Gamma, x \of X \types M : \tycomp{Y}{\o,\i}
		}{
			\Gamma \types \tmfun{x : X}{M} : \tyfun{X}{\tycomp{Y}{\o,\i}}
		}
		\quad
		\coopinfer{Ty-Fun-Rec}{
			\Gamma,f \of \tyfun{X}{\tycomp{Y}{\o,\i}}, x \of X \types M : \tycomp{Y}{\o,\i}
		}{
			\Gamma \types \tmfunrec{f}{x : X}{M} : \tyfun{X}{\tycomp{Y}{\o,\i}}
		}
	\end{mathpar}
	\caption{Pravila za izračun tipov za vrednosti.}
	\label{fig:value-typing-rules}
\end{figure}

\begin{figure}[H]
	\centering
	\small
	\begin{mathpar}
		\coopinfer{TyComp-Return}{
			\Gamma \types V : X
		}{
			\Gamma \types \tmreturn{V} : \tycomp{X}{\o,\i} 
		}
		\qquad
		\coopinfer{TyComp-Let}{
			\Gamma \types M : \tycomp{X}{\o,\i}
			\\
			\Gamma, x \of X \types N : \tycomp{Y}{\o,\i} 
		}{												
			\Gamma \types
			\tmlet{x}{M}{N} : \tycomp{Y}{\o,\i}       
		}											
		\\
		\coopinfer{TyComp-Apply}{
			\Gamma \types V : \tyfun{X}{\tycomp{Y}{\o,\i}} \\
			\Gamma \types W : X
		}{
			\Gamma \types \tmapp{V}{W} : \tycomp{Y}{\o,\i}
		}
		\quad
		\coopinfer{TyComp-MatchPair}{
			\Gamma \types V : \typrod{X}{Y} \\
			\Gamma, x \of X, y \of Y \types M : \tycomp{Z}{\o,\i}
		}{
			\Gamma \types \tmmatch{V}{\tmpair{x}{y} \mapsto M} : \tycomp{Z}{\o,\i}
		}
		\\
		\coopinfer{TyComp-MatchEmpty}{
			\Gamma \types V : \tyempty
		}{
			\Gamma \types \tmmatch[\tycomp{Z}{(\o,\i)}]{V}{} : \tycomp{Z}{\o,\i}
		}
		\quad
		\coopinfer{TyComp-MatchSum}{
			\Gamma \types V : X + Y \\\\
			\Gamma, x \of X \types M : \tycomp{Z}{\o,\i} \\
			\Gamma, y \of Y \types N : \tycomp{Z}{\o,\i} \\
		}{
			\Gamma \types \tmmatch{V}{\tminl{x} \mapsto M, \tminr{y} \mapsto N} : \tycomp{Z}{\o,\i}
		}
		\\
		\coopinfer{TyComp-Signal}{
			\op \in \o \\
			\Gamma \types V : A_\op \\
			\Gamma \types M : \tycomp{X}{\o,\i} 
		}{
			\Gamma \types \tmopout{op}{V}{M} : \tycomp{X}{\o,\i}
		}
		\qquad
		\coopinfer{TyComp-Interrupt}{
			\Gamma \types V : A_\op \\
			\Gamma \types M : \tycomp{X}{\o,\i} 
		}{
			\Gamma \types \tmopin{op}{V}{M} : \tycomp{X}{\opincomp {op} (\o,\i)}
		}
		\\
		\coopinfer{TyComp-Promise}{
			\i\, (\op) = ({\o'} , {\i'}) \\
			\Gamma, x \of A_\op \types M : \tycomp{\typromise X}{\o',\i'} \\
			\Gamma, p \of \typromise X \types N : \tycomp{Y}{\o,\i} 
		}{
			\Gamma \types \tmwith{op}{x}{M}{p}{N} : \tycomp{Y}{\o,\i}
		}
		\\
		\coopinfer{TyComp-Await}{
			\Gamma \types V : \typromise X \\
			\Gamma, x \of X \types M : \tycomp{Y}{\o,\i} 
		}{
			\Gamma \types \tmawait{V}{x}{M} : \tycomp{Y}{\o,\i}
		}
		\qquad
		\coopinfer{TyComp-Subsume}{
			\Gamma \types M : \tycomp{X}{\o, \i} \\
			(\o,\i) \order {O \times I} (\o',\i')
		}{
			\Gamma \types M : \tycomp{X}{\o', \i'}
		}
	\end{mathpar}
	\caption{Pravila za izračun tipov za izračune.}
	\label{fig:computation-typing-rules}
\end{figure}

\begin{figure}[H]
	\centering
	\small
	\begin{mathpar}
		\coopinfer{TyProc-Run}{
			\Gamma \types M : \tycomp{X}{\o,\i}
		}{
			\Gamma \types \tmrun{M} : \tyrun{X}{\o, \i}
		}
		\quad
		\coopinfer{TyProc-Par}{
			\Gamma \types P : \tyC \\
			\Gamma \types Q : \tyD
		}{
			\Gamma \types \tmpar{P}{Q} : \typar{\tyC}{\tyD}
		}
		\\
		\coopinfer{TyProc-Signal}{
			\op \in \mathsf{signals\text{-}of}{(\tyC)} \\\\
			\Gamma \types V : A_\op \\
			\Gamma \types P : \tyC 
		}{
			\Gamma \types \tmopout{op}{V}{P} : \tyC
		}
		\quad
		\coopinfer{TyProc-Interrupt}{
			\Gamma \types V : A_\op \\
			\Gamma \types P : \tyC 
		}{
			\Gamma \types \tmopin{op}{V}{P} : \opincomp{op}{\tyC}
		}  
	\end{mathpar}
	\caption{Pravila za izračun tipov za procese.}
	\label{fig:process-typing-rules}
\end{figure}

\begin{figure}[H]
	\centering

	\textbf{Delni rezultati}
	\begin{mathpar}
		\coopinfer{R-Signal}{
			\RunResult {\Psi} {M}
		}{
			\RunResult {\Psi} {\tmopout{op}{V}{M}}
		}
		\qquad
		\coopinfer{R-Comp}{
			\CompResult {\Psi} {M}
		}{
			\RunResult {\Psi} {M}
		}
		\\
		\coopinfer{R-Return}{
		}{
			\CompResult {\Psi} {\tmreturn V}
		}
		\qquad
		\coopinfer{R-Promise}{
			\CompResult {\Psi \cup \{p\}} {N}
		}{
			\CompResult {\Psi} {\tmwith {op} x M p N}
		}
		\\
		\coopinfer{R-Await}{
			p \in \Psi
		}{
			\CompResult {\Psi} {\tmawait{p}{x}{M}}
		}
	\end{mathpar}

	\textbf{Rezultati}
	\begin{mathpar}
		\coopinfer{R-Out}{
			\ProcResult {P}
		}{
			\ProcResult {\tmopout {op} V P}
		}
		\qquad
		\coopinfer{R-Process}{
			\ParResult {P}
		}{
			\ProcResult {P}
		}
		\\
		\coopinfer{R-Parallel}{
			\ParResult P \\
			\ParResult Q
		}{
			\ParResult {\tmpar P Q}
		}
		\qquad
		\coopinfer{R-Run}{
			\RunResult {\emptyset} {M}
		}{
			\ParResult {\tmrun M}
		}
	\end{mathpar}
	\caption{Rezultati in delni rezultati.}
	\label{fig:results-rules}
\end{figure}


Izrek o varnosti, ki je sestavljen iz izreka o ohranitvi in izreka o napredku nam zagotavlja, da ne moremo dobiti runtime, če imamo tipe, kot smo jih definirali.

\begin{lema}\label{lem:ni-spremenljivka}
	Če za vrednost $V$ velja $x_1 \of \typromise{A_1}, x_2 \of \typromise{A_2}, ..., x_n \of \typromise{A_n} \types V \of A$, kjer je $A$ tip, ki se ne pojavi v kontekstu $\Gamma$, potem vrednost $V$ ni spremenljivka.
	\begin{itemize}
		\item Če je $A$ enak $B_1 \times B_2$, potem je $V$ enak $(W_1,W_2)$.
		\item Če je $A$ enak $B_1 + B_2$, potem je $V$ ali enak $\tminl{W_1}$ ali $\tminr{W_2}$.
		\item Če je $A$ enak $\tyfun{B_1}{\tycomp{B_2}{\o, \i}}$, potem je $V$ ali enak $\tmfunano{x}{M}$ ali $\tmfunrecano{f}{x}{M}$.
	\end{itemize}
\end{lema}

\begin{proof}
	Predpostavimo, da je $V$ spremenljivka. Edino pravilo za določitev tipa spremenljivke je \rulename{TIP-VAR}. Od tod sledi, da je tip $A$ v kontekstu $\Gamma$. Kar je v protislovju z predpostavko leme, da se tip $A$ ne pojavi v kontekstu $\Gamma$.
	\begin{itemize}
		\item Edini pravili za tip $B_1 \times B_2$ sta \rulename{Ty-Var} in \rulename{Ty-Pair}. Ker $V$ ni spremenljivka, je bilo uporabljeno pravilo \rulename{Ty-Pair}. Posledično je $V$ oblike $\tmpair{W_1}{W_2}$.
		
		\item Edina pravila za tip $B_1 + B_2$ so \rulename{Ty-Var}, \rulename{Ty-Inl} in \rulename{Ty-Inr}. Ker $V$ ni spremenljivka, je bilo uporabljeno pravilo \rulename{Ty-Inl} ali \rulename{Ty-Inr}. Posledično je $V$ oblike $\tminl{W_1}$ ali $\tminr{W_2}$.
		
		\item Edina pravila za tip $\tyfun{B_1}{\tycomp{B_2}{\o, \i}}$ so \rulename{Ty-Var}, \rulename{Ty-Fun} in \rulename{Ty-Fun-Rec}. Ker $V$ ni spremenljivka, je bilo uporabljeno pravilo \rulename{Ty-Fun} ali \rulename{Ty-Fun-Rec}. Posledično je $V$ oblike $\tmfunano{x}{M}$ ali $\tmfunrecano{f}{x}{M}$.
	\end{itemize}
\end{proof}


\begin{trditev}[o napredku]\label{trd:gamma-napredek}
	Naj za izračun $M$ velja $\Gamma \types M \of \tycomp{A}{\o, \i}$, kjer je $\Gamma = x_1 \of \typromise{A_1}, x_2 \of \typromise{A_2},..., x_i \of \typromise{A_i}$. Potem ali (i) obstaja izračun $M'$, tak da $M \reduces M'$, ali pa (ii) velja $\RunResult{\Gamma}{M}$.
\end{trditev}

\begin{proof}
	Ker ima izračun $M$ tip, obstaja drevo izpeljave za njegov tip.
	Dokazujemo z strukturno indukcijo na drevo izpeljave za izračune. \jR{More precisely state which derivation}
	Ločimo primere glede na zadnje uporabljeno pravilo.
	
	\begin{itemize}
		\item Če je zadnje pravilo \rulename{TyComp-Return},je $M$ enak $\tmreturn{V}$. 
		Po pravilih \rulename{R-Return} in \rulename{R-Comp} sledi, da je $M$ delni rezultat in velja (ii).
		
		\item Če je zadnje pravilo \rulename{TyComp-Let}, potem je $M$ enak $\tmlet{x}{N_1}{N_2}$.
		Izračun $N_1$ ima tip in po $IP$ lahko naredi korak ali pa je delni rezultat. Če $N_1$ lahko naredi korak v $N_1'$, potem lahko po pravilu za evalvacijo v okolju tudi $M$ naredi korak v $\tmlet{x}{N_1'}{N_2}$.
		Če pa je $N_1$ delni rezultat, ločimo štiri možnosti. 
		\begin{itemize}
			\item Če je $N_1$ enak $\tmreturn{V}$, potem lahko $M$ naredi korak v izračun $N_2[V/x]$.
			\item Če je $N_1$ enak $\tmopout{op}{V}{N_3}$, potem lahko $M$ naredi korak v $\tmopout{op}{V}{(\tmlet{x}{N_3}{N_2})}$.
			\item Če je $N_1$ enak $\tmwith{op}{x}{N_3}{p}{N_4}$, lahko $M$ naredi korak v $\tmwith{op}{x}{N_3}{p}{(\tmlet{x}{N_4}{N_2})}$.
			\item Če pa je $N_1$ enak $\tmawait{p}{y}{N_3}$, lahko $M$ naredi korak v $\tmawait{p}{y}{(\tmlet{x}{N_3}{N_2})}$.
		\end{itemize}
	
		\item Če je uporabljeno pravilo \rulename{TyComp-Apply}, potem je $M$ enak $V W$. Ker ima vrednost $V$ tip $\tyfun{B_1}{B_2}$ in v kontekstu nobena spremenljivka nima tipa $X \times Y$, je po lemi~\ref{lem:ni-spremenljivka} vrednost $V$ oblike $\tmfunano{x}{M}$ ali $\tmfunrecano{f}{x}{M}$. Posledično lahko naredimo korak v $M[W/x]$ ali $M[V/x, (\tmfunrec{f}{x \of X}{M})/f]$.
		
		\item Če je zadnje pravilo \rulename{TyComp-MatchPair}, potem je $M$ enak $\tmmatch{V}{(x,y) \mapsto N}$. Ker ima vrednost $V$ tip $X \times Y$ in v kontekstu nobena spremenljivka nima tipa $X \times Y$, je po lemi~\ref{lem:ni-spremenljivka} vrednost $V$ oblike $(W_1,W_2)$. Posledično lahko $M$ naredi korak v izračun $N[W_1/x,W_2/y]$.
		
		\item Zadnje pravilo ne more biti \rulename{TyComp-MatchEmpty}. Če bi bilo zadnje pravilo \rulename{TyComp-MatchEmpty}, bi vrednost $V$ imela tip $0$. 
		Ker v kontekstu nobena spremenljivka nima tipa $0$, $V$ ne more biti spremenljivka po lemi~\ref{lem:ni-spremenljivka}.
		Ker ne obstaja nobeno drugo pravilo za tip $0$, take vrednosti ne moremo imeti, in posledično zadnje uporabljeno pravilo ne more biti \rulename{TyComp-MatchEmpty}.

		
		\item Če je zadnje pravilo \rulename{TyComp-MatchSum}, potem je $M$ enak $\tmmatch{V}{\tminl{x} \mapsto N_1, \tminr{y} \mapsto N_2}$.
		Ker ima vrednost $V$ tip $X + Y$ in v kontekstu nobena spremenljivka nima tipa $X + Y$, je po lemi~\ref{lem:ni-spremenljivka} vrednost $V$ oblike $\tminl{W_1}$ ali $\tminr{W_2}$.
		\begin{itemize}
			\item Če je oblike $\tminl{W_1}$ lahko $M$ naredi korak v $N_1[W_1/x]$.
			\item Sicer je oblike $\tminr{W_2}$ in lahko $M$ naredi korak v $N[W_2/y]$.
		\end{itemize}
		
		\item Če je zadnje pravilo \rulename{TyComp-Signal}, potem je $M$ enak $\tmopout{op}{V}{N}$.
		Po $IP$ lahko ali $N$ naredi korak v $N'$ posledično lahko $M$ naredi korak v $\tmopout{op}{V}{N'}$.
		Ali pa je $N$ delni rezultat in je posledično po pravilu \rulename{R-Signal} tudi $M$ delni rezultat.
		
		\item Če je zadnje pravilo \rulename{TyComp-Interrupt}, potem je $M$ enak $\tmopin{op}{V}{N}$. Izračun $N$ ima tip in po $IP$ lahko naredi korak ali pa je že delna vrednost. Če $N$ lahko naredi korak v $N'$, potem po pravilu za evalvacijo v okolju tudi $M$ lahko naredi korak v $\tmopin{op}{V}{N'}$. 
		Če pa je $N$ delni rezultat ločimo štiri možnosti.
		\begin{itemize}
			\item Če je $N$ enak $\tmreturn{V}$, potem lahko $M$ naredi korak v $\tmreturn{V}$.
			\item Če je $N$ enak $\tmopout{op'}{W}{O}$, potem lahko $M$ naredi korak v $\tmopout{op'}{W}{(\tmopin{op}{V}{O})}$.
			\item Če je $N$ enak $\tmwith{op'}{x}{O}{p}{O'}$, potem lahko $M$ naredi ali korak v $\tmlet{p}{O[V/x]}{O'}$, če velja $op = op'$, ali v $\tmwith{op'}{x}{O}{p}{\tmopin{op}{V}{O'}}$ sicer.
			\item Če pa je $N$ enak $\tmawait{p}{x}{O}$, lahko $M$ naredi korak v $\tmawait{p}{x}{(\tmopin{op}{V}{O})}$.
		\end{itemize}
		
		
		\item Če je zadnje pravilo \rulename{TyComp-promise}, potem je $M$ enak $\tmwith{op}{x}{N_1}{p}{N_2}$. Izračun $N_2$ ima tip in po $IP$ lahko $N_2$ naredi korak ali pa je že delna vrednost. Če $N_2$ lahko naredi korak v $N_2'$, potem po pravilu za evalvacijo v okolju tudi $M$ lahko naredi korak v $\tmwith{op}{x}{N_1}{p}{N_2'}$.
		Če pa je $N_2$ delni rezultat, ločimo dva primera.
		\begin{itemize}
			\item Če je zadnje pravilo za določitev delnega rezultata $N_2$ pravilo \rulename{R-Comp}, potem je tudi $M$ delni rezultat po pravilih \rulename{R-Comp} in \rulename{R-Promise}.
			\item Če pa je zadnje pravilo za določitev delnega rezultata $N_2$ pravilo \rulename{R-Signal}, potem je $N_2$ oblike $\tmopout{op'}{V}{N_3}$ in posledično lahko $M$ naredi korak v $\tmopout{op}{V}{\tmwith{op}{x}{N_1}{p}{N_3}}$.
		\end{itemize}
		 
		
		\item Če je zadnje pravilo \rulename{TyComp-Await}, potem je $M$ oblike $\tmawait{V}{p}{N}$.
		Ločimo dva primera.
		\begin{itemize}
			\item Če je $V$ spremenljivka v kontekstu $\Gamma$, potem je po pravilih \rulename{R-Comp} in \rulename{R-Await} $M$ delni rezultat.
			\item Sicer je $V$ enak $\tmpromise{W}$. Tedaj lahko $M$ naredi korak v $N[W/p]$.
		\end{itemize}
		
		\item Če je zadnje pravilo \rulename{TyComp-Subsume}, lahko $IP$ uporabimo direktno na $M$ in posledično lahko $M$ naredi korak ali pa je $M$ delni rezultat.
			
	\end{itemize}
	
\end{proof}


\begin{posledica}[o napredku]\label{pos:prazen-napredek}
	Naj za izračun $M$ velja $\emptyset \types M \of \tycomp{A}{\o, \i}$. Potem ali (i) obstaja izračun $M'$, tak da $M \reduces M'$, ali pa (ii) velja $\RunResult{\emptyset}{M}$.
\end{posledica}

\begin{proof}
	Trditev \ref{trd:gamma-napredek} velja za vsak kontekst $\Gamma$, torej tudi za $\Gamma = \emptyset$.
\end{proof}


\begin{izrek}[o napredku]
	Naj za proces $P$ velja $\emptyset \types P \of C$. Potem ali (i) obstaja proces $P'$, tak da $P \reduces P'$, ali pa (ii) velja $\ProcResult{P}$.
\end{izrek}

\begin{proof}
	Ker ima proces $P$ tip, obstaja drevo izpeljave za njegov tip.
	Dokazujemo z strukturno indukcijo na drevo izpeljave za procese.
	Ločimo primere glede na zadnje uporabljeno pravilo.
	
	\begin{itemize}
		\item Če je zadnje pravilo \rulename{TyProc-Run}, potem je $P$ enak $\tmrun{M}$. Ker ima $M$ tip, po posledici~\ref{pos:prazen-napredek} velja da, ali lahko $M$ naredi korak v $M'$ ali pa je $M$ delni rezultat.
		\begin{itemize}
			\item Če $M$ lahko naredi korak v $M'$, potem lahko po pravilu za evalvacijo v okolju tudi $P$ naredi korak v $\tmrun{M'}$.
			\item Sicer je $M$ delna vrednost in ločimo dva primera.
			\begin{itemize}
				\item Če je $M$ enak $\tmopout{op}{V}{N}$, potem lahko $P$ naredi korak v $\tmopout{op}{V}{\tmrun{N}}$.
				\item Sicer je tudi $P$ rezultat.
			\end{itemize}
		\end{itemize}
		\jR{Should i make itemize when ever we separate cases???}
		
		\item Če je zadnje pravilo \rulename{TyProc-Par}, potem je $P$ enak $\tmpar{Q_1}{Q_2}$. Ker imata $Q_1$ in $Q_2$ tip, lahko po $IP$ naredita korak ali pa sta že rezultata.
		Če lahko eden izmed njiju naredi korak, recimo $Q_1$ lahko naredi korak v $Q_1'$, lahko po pravilu za evalvacijo v okolju tudi $P$ naredi korak v $\tmpar{Q_1'}{Q_2}$. Podobno dokažemo, če lahko $Q_2$ naredi korak.
		Sicer sta $Q_1$ in $Q_2$ rezultata. Ločimo dva primera.
		\begin{itemize}
			\item Če je eden izmed njiju enak $\tmopout{op}{V}{Q'}$, recimo $Q_1$. Potem lahko $P$ naredi korak v $\tmopout{op}{V}{(\tmpair{Q'}{\tmopin{op}{V}{Q_2}})}$. Podobno za $Q_2$.
			\item Sicer je tudi $P$ rezultat.
		\end{itemize}
		
		\item Če je zadnje pravilo \rulename{TyProc-Signal}, potem je $P$ enak $\tmopout{op}{V}{Q}$. Proces $Q$ ima tip in po $IP$ lahko naredi korak ali pa je rezultat.
		Če $Q$ lahko naredi korak v $Q'$, potem lahko po pravilu za evalvacijo v okolju tudi $P$ naredi korak v $\tmopout{op}{V}{Q'}$.
		Sicer je tudi $P$ rezultat.
		
		\item Če je zadnje pravilo \rulename{TyProc-Interrupt}, potem je $P$ enak $\tmopin{op}{V}{Q}$. Proces $Q$ ima tip in po $IP$ lahko naredi korak ali pa je rezultat.
		Če $Q$ lahko naredi korak v $Q'$, potem lahko po pravilu za evalvacijo v okolju tudi $P$ naredi korak v $\tmopin{op}{V}{Q'}$.
		Če pa je $Q$ rezultat ločimo tri primere.
		\begin{itemize}
			\item Če je $Q$ enak $\tmrun{M}$, potem lahko $P$ naredi korak v $\tmrun{\tmopin{op}{V}{M}}$.
			\item Če je $Q$ enak $\tmopout{op'}{V'}{Q'}$, potem lahko $P$ naredi korak v $\tmopout{op'}{V'}{(\tmopin{op}{V}{Q'})}$.
			\item Če je $Q$ enak $\tmpar{Q_1}{Q_2}$, potem lahko $P$ naredi korak v $\tmpar{\tmopin{op}{V}{Q_1}}{\tmopin{op}{V}{Q_2}}$.
		\end{itemize}
		
	\end{itemize}
		
\end{proof}


\begin{lema}\label{lem:strengthening-gamma}
	Naj za spremenljivko $y$ velja $\Gamma_1, x \of A, \Gamma_2 \types y \of B$ za $y \neq x$. Potem velja $\Gamma_1, \Gamma_2 \types y \of B$.
\end{lema}

\begin{proof}
	Edino pravilo za določitev tipa spremenljivke je \rulename{Ty-Var}. Posledično velja $y \of B \in \Gamma_1$ ali $y \of B \in \Gamma_2$. V obeh primerih po pravilu \rulename{Ty-Var} sledi $\Gamma_1, \Gamma_2 \types y \of B$.
\end{proof}

Lemo o substituciji razdelimo na dve lemi, ki uporabljata druga drugo.

\begin{lema}[o substituciji za vrednosti]\label{lem:substitucija-vrednosti}
	Naj za vrednost $V$ velja $\Gamma_1 \types V \of A$ in za vrednost $W$ velja $\Gamma_1, x \of A, \Gamma_2 \types W \of B$. Potem velja $\Gamma_1, \Gamma_2 \types W[V/x] \of B$.
\end{lema}

\begin{proof}
	Ker ima vrednost $W$ tip, obstaja drevo izpeljave za njegov tip.
	Dokazujemo z strukturno indukcijo na drevo izpeljave za $\Gamma_1, x \of A, \Gamma_2 \types W \of B$.
	Ločimo primere glede na zadnje uporabljeno pravilo.
	
	\begin{itemize}
		\item Če je zadnje pravilo \rulename{Ty-Var}, potem je $W$ enak $y$. Ločimo dva primera.
		\begin{itemize}
			\item Če je spremenljivka $y = x$, potem je $W[V/x] = y[V/x] = V$. Ker je $y = x$, je $A = B$. Ker je $A = B$, je tip $W[V/x] = V$ enak $B$.
			\item Če je spremenljivka $y \neq x$, potem je $W[V/x] = y$. Po lemi~\ref{lem:strengthening-gamma} ima $y$ tip $B$.
		\end{itemize}
	
		\item Če je zadnje pravilo \rulename{Ty-Cons-N}, potem je $W=n$ in $B=int$. Ker je $W[V/x] = n[V/x] = n$, ima $W[V/x]$ tip $int = B$, po pravilu \rulename{Ty-Cons-N}.
		\item Če je zadnje pravilo \rulename{Ty-Cons-T}, potem je $W=true$ in $B=bool$. Ker je $W[V/x] = true[V/x] = true$, ima $W[V/x]$ tip $bool = B$, po pravilu \rulename{Ty-Cons-T}. 
		\item Če je zadnje pravilo \rulename{Ty-Cons-F}, potem je $W$ enak $false$ in $B$ enak $bool$. Ker je $W[V/x] = false[V/x] = false$, ima $W[V/x]$ tip $bool = B$, po pravilu \rulename{Ty-Cons-F}.
		
		\item Če je zadnje pravilo \rulename{Ty-Pair}, potem je $W =\tmpair{W_1}{W_2}$ in $B = B_1 \times B_2$. Po $IP$ imata $W_1[V/x]$ in $W_2[V/x]$ tip $B_1$ in $B_2$.
		Ker je $W[V/x] = \tmpair{W_1[V/x]}{W_2[V/x]}$, ima vrednost $W[V/x]$ tip $\typrod{B_1}{B_2} = B$ po pravilu \rulename{Ty-Pair}.
		
		\item Če je zadnje pravilo \rulename{Ty-Promise}, potem je $W = \tmpromise{W'}$ in $B = \typromise{B'}$. Po $IP$ ima $W'[V/x]$ tip $B'$.
		Ker je $W[V/x] = \tmpromise{W'}$, ima vrednost $W[V/x]$ tip $\typromise{B'} = B$ po pravilu \rulename{Ty-Promise}.
		
		\item Če je zadnje pravilo \rulename{Ty-Inl}, potem je $W = \tminl{W_1}$ in $B = B_1 + B_2$. Po $IP$ ima $W_1[V/x]$ tip $B_1$.
		Ker je $W[V/x] = \tminl{W_1[V/x]}$, ima vrednost $W[V/x]$ tip $B_1 + B_2 = B$ po pravilu \rulename{Ty-Sum}.
		
		\item Če je zadnje pravilo \rulename{Ty-Inr}, potem je $W = \tminr{W_2}$ in $B = B_1 + B_2$. Po $IP$ ima $W_2[V/x]$ tip $B_2$.
		Ker je $W[V/x] = \tminr{W_2[V/x]}$, ima vrednost $W[V/x]$ tip $B_1 + B_2 = B$ po pravilu \rulename{Ty-Sum}.
		
		\item Če je zadnje pravilo \rulename{Ty-Fun}, potem je $W = \tmfunano{y}{M}$ in $B = \tyfun{B_1}{B_2}$. Po lemi~\ref{lem:substitucija-izračuni} ima $M[V/x]$ tip $B_2$.
		Ker je $W[V/x] = \tmfunano{y}{M[V/x]}$, ima vrednost $W[V/x]$ tip $\tyfun{B_1}{B_2}$ po pravilu \rulename{Ty-Fun}.
		
		\item Če je zadnje pravilo \rulename{Ty-Fun-Rec}, potem je $W = \tmfunrecano{f}{y}{M}$ in $B = \tyfun{B_1}{B_2}$. Po lemi~\ref{lem:substitucija-izračuni} ima $M[V/x]$ tip $B_2$.
		Ker je $W[V/x] = \tmfunrecano{f}{y}{M[V/x]}$, ima vrednost $W[V/x]$ tip $\tyfun{B_1}{B_2}$ po pravilu \rulename{Ty-Fun-Rec}.
	\end{itemize}
\end{proof}


\begin{lema}[o substituciji za izračune]\label{lem:substitucija-izračuni}
	Naj za vrednost $V$ velja $\Gamma_1 \types V \of A$ in za izračun $M$ velja $\Gamma_1, x \of A, \Gamma_2 \types M \of \tycomp{B}{\o, \i}$. Potem velja $\Gamma_1, \Gamma_2 \types M[V/x] \of \tycomp{B}{\o, \i}$.
\end{lema}

\begin{proof}
	Dokazujemo z strukturno indukcijo na drevo izpeljave za $\Gamma_1, x \of A, \Gamma_2 \types M \of \tycomp{B}{\o, \i}$.
	Ločimo primere glede na zadnje uporabljeno pravilo.
	
	\begin{itemize}
		\item Če je zadnje pravilo \rulename{TyComp-Return}, potem je $M$ enak $\tmreturn{W}$. Vrednost $W$ ima tip $B$. Po lemi~\ref{lem:substitucija-vrednosti} ima $W[V/x]$ tip $B$. Po pravilu \rulename{TyComp-Return} ima $M'$ tip $\tycomp{B}{\o, \i}$.
		
		\item Če je zadnje pravilo \rulename{TyComp-Let}, potem je $M$ enak $\tmlet{x}{N_1}{N_2}$. Izračuna $N_1$ in $N_2$ imata tip $\tycomp{C}{\o, \i}$ in $\tycomp{B}{\o, \i}$.
		Po $IP$ velja, da imata $N_1[V/x]$ in $N_2[V/x]$ isti tip. Ker je $M[V/x]$ enak $\tmlet{x}{N_1[V/x]}{N_2[V/x]}$, ima izračun $M[V/x]$ tip $\tycomp{B}{\o, \i}$ po pravilu \rulename{TyComp-Let}.
		
		\item Če je zadnje pravilo \rulename{TyComp-Apply}, potem je $M$ enak $W_1 W_2$. Vrednost $W_1$ ima tip $\tyfun{C}{\tycomp{B}{\o, \i}}$ in vrednost $W_2$ ima tip $C$.
		Po lemi~\ref{lem:substitucija-vrednosti} imata $W_1[V/x]$ in $W_2[V/]$ isti tip. Ker je $M[V/x]$ enak $W_1[V/x] W_2[V/x]$, ima izračun $M[V/x]$ tip $\tycomp{B}{\o, \i}$ po pravilu \rulename{TyComp-Apply}.
		
		\item Če je zadnje pravilo \rulename{TyComp-MatchPair}, potem je $M$ enak $\tmmatch{W}{(y_1,y_2) \mapsto N}$. 
		Ker ima vrednost $W$ tip $X \times Y$, ima tudi $W[V/x]$ tip $X \times Y$ po lemi~\ref{lem:substitucija-vrednosti}.
		Ker ima $N$ tip $\tycomp{B}{\o, \i}$, ima tudi $N[V/x]$ tip $\tycomp{B}{\o, \i}$ po $IP$.
		Ker je $M[V/x]$ enak $\tmmatch{W[V/x]}{(y_1,y_2) \mapsto N[V/x]}$, ima izračun $M[V/x]$ tip $\tycomp{B}{\o, \i}$ po pravilu \rulename{TyComp-MatchPair}. 
		
		\item Če je zadnje pravilo \rulename{TyComp-MatchEmpty}, potem je $M$ enak $\tmmatch{W}{}$.
		Ker ima vrednost $W$ tip $X \times Y$, ima tudi $W[V/x]$ tip $X \times Y$ po lemi~\ref{lem:substitucija-vrednosti}.
		Ker je $M[V/x]$ enak $\tmmatch{W[V/x]}{}$, ima izračun $M[V/x]$ tip $\tycomp{B}{\o, \i}$ po pravilu \rulename{TyComp-MatchEmpty}.
		
		\item Če je zadnje pravilo \rulename{TyComp-MatchSum}, potem je $M$ enak $\tmmatch{W}{\tminl{y_1} \mapsto N_1, \tminr{y_2} \mapsto N_2}$.
		Ker ima vrednost $W$ tip $X + Y$, ima tudi $W[V/x]$ tip $X + Y$ po lemi~\ref{lem:substitucija-vrednosti}.
		Ker imata $N_1$ in $N_2$ tip $\tycomp{B}{\o, \i}$, imata tudi $N_1[V/x]$ in $N_2[V/x]$ tip $\tycomp{B}{\o, \i}$ po $IP$.
		Ker je $M[V/x]$ enak $\tmmatch{W[V/x]}{\tminl{y_1} \mapsto N_1[V/x], \tminr{y_2} \mapsto N_2[V/x]}$, ima izračun $M[V/x]$ tip $\tycomp{B}{\o, \i}$ po pravilu \rulename{TyComp-MatchSum}.
		
		\item Če je zadnje pravilo \rulename{TyComp-Signal}, potem je $M$ enak $\tmopout{op}{W}{N}$.
		Ker ima vrednost $W$ tip $C_{op}$, ima tudi $W[V/x]$ tip $C_{op}$ po lemi~\ref{lem:substitucija-vrednosti}.
		Ker ima $N$ tip $\tycomp{B}{\o, \i}$, ima tudi $N[V/x]$ tip $\tycomp{B}{\o, \i}$ po $IP$.
		Ker je $M[V/x]$ enak $\tmopout{op}{W[V/x]}{N[V/x]}$, ima izračun $M[V/x]$ tip $\tycomp{B}{\o, \i}$ po pravilu \rulename{TyComp-Signal}.
		
		\item Če je zadnje pravilo \rulename{TyComp-Interrupt}, potem je $M$ enak $\tmopin{op}{W}{N}$ in $(\o, \i) = \opincomp{op}{\o', \i'}$.
		Ker ima vrednost $W$ tip $C_{op}$, ima tudi $W[V/x]$ tip $C_{op}$ po lemi~\ref{lem:substitucija-vrednosti}.
		Ker ima $N$ tip $\tycomp{B}{\o', \i'}$, ima tudi $N[V/x]$ tip $\tycomp{B}{\o', \i'}$ po $IP$.
		Ker je $M[V/x]$ enak $\tmopin{op}{W[V/x]}{N[V/x]}$, ima izračun $M[V/x]$ tip $\tycomp{B}{\o, \i}$ po pravilu \rulename{TyComp-Signal}.
		
		\item Če je zadnje pravilo \rulename{TyComp-Promise}, potem je $M$ enak $\tmwith{op}{y}{N_1}{p}{N_2}$.
		Ker ima $N_1$ tip $\tycomp{\typromise{C}}{\o', \i'}$, ima tudi $N_1[V/x]$ tip $\tycomp{\typromise{C}}{\o', \i'}$ po $IP$.
		Ker ima $N_2$ tip $\tycomp{B}{\o, \i}$, ima tudi $N_2[V/x]$ tip $\tycomp{B}{\o, \i}$ po $IP$.
		Ker je $M[V/x]$ enak $\tmwith{op}{y}{N_1}{p}{N_2}$, ima izračun $M[V/x]$ tip $\tycomp{B}{\o, \i}$ po pravilu \rulename{TyComp-Promise}.
		
		\item Če je zadnje pravilo \rulename{TyComp-Await}, potem je $M$ enak $\tmawait{W}{y}{N}$.
		Ker ima vrednost $W$ tip $\typromise{C}$, ima tudi $W[V/x]$ tip $\typromise{C}$ po lemi~\ref{lem:substitucija-vrednosti}.
		Ker ima $N$ tip $\tycomp{B}{\o', \i'}$, ima tudi $N[V/x]$ tip $\tycomp{B}{\o', \i'}$ po $IP$.
		Ker je $M[V/x]$ enak $\tmawait{W[V/x]}{y}{N[V/x]}$, ima izračun $M[V/x]$ tip $\tycomp{B}{\o, \i}$ po pravilu \rulename{TyComp-Await}.
		
		\item Če je zadnje pravilo \rulename{TyComp-Subsume}, potem ima $M$ tip $\tycomp{B}{\o', \i'}$, kjer je $(\o', \i') \order{O \times I} (\o, \i)$.
		Po $IP$ ima tudi $M[V/x]$ tip $\tycomp{B}{\o', \i'}$. Po pravilu \rulename{TyComp-Subsume} ima $M[V/x]$ tip $\tycomp{B}{\o, \i}$.
		
	\end{itemize}

\end{proof}

\begin{lema}\label{lem:tovor-osnovni-tip-skrcitev}
	Naj za vrednost $V$ velja $\Gamma_1, x \of \typromise{A}, \Gamma_2 \types V \of B$, kjer je $B$ osnovni tip. Potem velja $\Gamma_1, \Gamma_2 \types V \of B$.
\end{lema}

\begin{proof}
	Dokazujemo z strukturno indukcijo na drevo izpeljave za $\Gamma_1, p \of \typromise{A}, \Gamma_2 \types V \of B$.
	Ločimo primere glede na zadnje uporabljeno pravilo.
	
	\begin{itemize}
		\item Če je zadnje pravilo \rulename{Ty-Var'}, potem je $V = y$. Ker $\typromise{A}$ ni osnoven tip, velja $y \in \Gamma_1$ ali $y \in \Gamma_2$.
		Po pravilu \rulename{Ty-Var'} velja $\Gamma_1, \Gamma_2, \bb \types V \of B$.
		
		\item Če je zadnje pravilo \rulename{Ty-Cons-N}, potem je $V = n$.Po pravilu \rulename{Ty-Cons-N} velja $\Gamma_1, \Gamma_2 \types V \of B$.
		\item Če je zadnje pravilo \rulename{Ty-Cons-T}, potem je $V = true$. Po pravilu \rulename{Ty-Cons-T} velja $\Gamma_1, \Gamma_2 \types V \of B$.
		\item Če je zadnje pravilo \rulename{Ty-Cons-F}, potem je $V = false$. Po pravilu \rulename{Ty-Cons-F} velja $\Gamma_1, \Gamma_2 \types V \of B$.
		
		\item Če je zadnje pravilo \rulename{Ty-Pair}, potem je $V =\tmpair{V_1}{V_2}$.
		Po $IP$ imata $V_1$ in $V_2$ isti tip v skrčenem kontekstu.
		Po pravilu \rulename{Ty-Pair} velja $\Gamma_1, \Gamma_2, \bb \types V \of B$.
		
		\item Zadnje pravilo ne more biti \rulename{Ty-Promise}, saj v tem primeru $B$ ni osnovni tip.
		
		\item Če je zadnje pravilo \rulename{Ty-Inl}, potem je $V = \tminl{V_1}$.
		Po $IP$ ima $V_1$ isti tip v skrčenem kontekstu.
		Po pravilu \rulename{Ty-Inl} velja $\Gamma_1, \Gamma_2, \bb \types V \of B$.
		
		\item Če je zadnje pravilo \rulename{Ty-Inr}, potem je $V = \tminl{V_2}$.
		Po $IP$ ima $V_2$ isti tip v skrčenem kontekstu.
		Po pravilu \rulename{Ty-Inr} velja $\Gamma_1, \Gamma_2, \bb \types V \of B$.
		
		\item Zadnje pravilo ne more biti \rulename{Ty-Fun}, saj v tem primeru $B$ ni osnovni tip.
		
		\item Zadnje pravilo ne more biti \rulename{Ty-Fun-Rec}, saj v tem primeru $B$ ni osnovni tip.
		
	\end{itemize}
\end{proof}

Sledeči lemi o šibitvi konteksta za vrednosti in izračune se nanašata ena na drugo.

\begin{lema}\label{lem:weakening-values}
	Naj za vrednost $V$ velja $\Gamma_1, \Gamma_2 \types V \of A$. Za vsak kontekst $\Gamma_3$, ki vsebuje le sveže spremenljivke glede na $\Gamma_1$ in $\Gamma_2$, velja $\Gamma_1, \Gamma_3, \Gamma_2 \types V \of A$.
\end{lema}

\begin{proof}
	Dokazujemo z strukturno indukcijo na drevo izpeljave za $\Gamma_1, \Gamma_2 \types V \of A$.
	Ločimo primere glede na zadnje uporabljeno pravilo.
	
	\begin{itemize}
		\item Če je zadnje pravilo \rulename{Ty-Var}, potem je $V = x$ in velja $x \in \Gamma_1$ ali $x \in \Gamma_2$. Po pravilu \rulename{Ty-Var} velja $\Gamma_1, \Gamma_3, \Gamma_2 \types V \of A$.
		
		\item Če je zadnje pravilo \rulename{Ty-Cons-N}, potem je $V = n$. Po pravilu \rulename{Ty-Cons-N} velja $\Gamma_1, \Gamma_3, \Gamma_2 \types V \of A$.
		\item Če je zadnje pravilo \rulename{Ty-Cons-T}, potem je $V = true$. Po pravilu \rulename{Ty-Cons-T} velja $\Gamma_1, \Gamma_3, \Gamma_2 \types V \of A$.
		\item Če je zadnje pravilo \rulename{Ty-Cons-F}, potem je $V = false$. Po pravilu \rulename{Ty-Cons-F} velja $\Gamma_1, \Gamma_3, \Gamma_2 \types V \of A$.
		
		\item Če je zadnje pravilo \rulename{Ty-Pair}, potem je $V =\tmpair{V_1}{V_2}$. Po $IP$ imata $V_1$ in $V_2$ isti tip v razširjenem kontekstu.
		Po pravilu \rulename{Ty-Pair} velja $\Gamma_1, \Gamma_3, \Gamma_2 \types V \of A$.
		
		\item Če je zadnje pravilo \rulename{Ty-Promise}, potem je $V = \tmpromise{V'}$. Po $IP$ ima $V'$ isti tip v razširjenem kontekstu.
		Po pravilu \rulename{Ty-Promise} velja $\Gamma_1, \Gamma_3, \Gamma_2 \types V \of A$.
		
		\item Če je zadnje pravilo \rulename{Ty-Inl}, potem je $V = \tminl{V_1}$. Po $IP$ ima $V_1$ isti tip v razširjenem kontekstu.
		Po pravilu \rulename{Ty-Inl} velja $\Gamma_1, \Gamma_3, \Gamma_2 \types V \of A$.
		
		\item Če je zadnje pravilo \rulename{Ty-Inr}, potem je $V = \tminl{V_2}$. Po $IP$ ima $V_2$ isti tip v razširjenem kontekstu.
		Po pravilu \rulename{Ty-Inr} velja $\Gamma_1, \Gamma_3, \Gamma_2 \types V \of A$.
		
		\item Če je zadnje pravilo \rulename{Ty-Fun}, potem je $V = \tmfunano{x}{M}$. Po lemi~\ref{lem:weakening-comp} ima $M$ isti tip v razširjenem kontekstu.
		Po pravilu \rulename{Ty-Fun} velja $\Gamma_1, \Gamma_3, \Gamma_2 \types V \of A$.
		
		\item Če je zadnje pravilo \rulename{Ty-Fun-Rec}, potem je $V = \tmfunrecano{f}{x}{M}$. Po lemi~\ref{lem:weakening-comp} ima $M$ isti tip v razširjenem kontekstu.
		Po pravilu \rulename{Ty-Fun-Rec} velja $\Gamma_1, \Gamma_3, \Gamma_2 \types V \of A$.
	\end{itemize}
\end{proof}

\begin{lema}\label{lem:weakening-comp}
	Naj za izračun $M$ velja $\Gamma_1, \Gamma_2 \types M \of \tycomp{A}{\o, \i}$. Za vsak kontekst $\Gamma_3$, ki vsebuje le sveže spremenljivke glede na $\Gamma_1$ in $\Gamma_2$, velja $\Gamma_1, \Gamma_3, \Gamma_2 \types M \of \tycomp{A}{\o, \i}$
\end{lema}

\begin{proof}
	Dokazujemo z strukturno indukcijo na drevo izpeljave za $\Gamma_1, \Gamma_2 \types M \of \tycomp{A}{\o, \i}$.
	Ločimo primere glede na zadnje uporabljeno pravilo.
	
	\begin{itemize}
		\item Če je zadnje pravilo \rulename{TyComp-Return}, potem je $M$ enak $\tmreturn{V}$.
		Po lemi~\ref{lem:weakening-values} ima $V$ isti tip v razširjenem kontekstu.
		Po pravilu \rulename{TyComp-Return} velja $\Gamma_1, \Gamma_3, \Gamma_2 \types M \of \tycomp{A}{\o, \i}$.
		
		\item Če je zadnje pravilo \rulename{TyComp-Let}, potem je $M$ enak $\tmlet{x}{N_1}{N_2}$.
		Po $IP$ imata $N_1$ in $N_2$ isti tip v razširjenem kontekstu.
		Po pravilu \rulename{TyComp-Let} velja $\Gamma_1, \Gamma_3, \Gamma_2 \types M \of \tycomp{A}{\o, \i}$.
		
		\item Če je zadnje pravilo \rulename{TyComp-Apply}, potem je $M$ enak $V_1 V_2$.
		Po lemi~\ref{lem:weakening-values} imata $V_1$ in $V_2$ isti tip v razširjenem kontekstu.
		Po pravilu \rulename{TyComp-Apply} velja $\Gamma_1, \Gamma_3, \Gamma_2 \types M \of \tycomp{A}{\o, \i}$.
		
		\item Če je zadnje pravilo \rulename{TyComp-MatchPair}, potem je $M$ enak $\tmmatch{V}{(x_1,x_2) \mapsto N}$. 
		Po lemi~\ref{lem:weakening-values} ima $V$ isti tip v razširjenem kontekstu.
		Po $IP$ ima $N$ isti tip v razširjenem kontekstu.
		Po pravilu \rulename{TyComp-MatchPair} velja $\Gamma_1, \Gamma_3, \Gamma_2 \types M \of \tycomp{A}{\o, \i}$.
		
		\item Če je zadnje pravilo \rulename{TyComp-MatchEmpty}, potem je $M$ enak $\tmmatch{V}{}$.
		Po lemi~\ref{lem:weakening-values} ima $V$ isti tip v razširjenem kontekstu.
		Po pravilu \rulename{TyComp-MatchEmpty} velja $\Gamma_1, \Gamma_3, \Gamma_2 \types M \of \tycomp{A}{\o, \i}$.
		
		\item Če je zadnje pravilo \rulename{TyComp-MatchSum}, potem je $M$ enak $\tmmatch{V}{\tminl{x_1} \mapsto N_1, \tminr{x_2} \mapsto N_2}$.
		Po lemi~\ref{lem:weakening-values} ima $V$ isti tip v razširjenem kontekstu.
		Po $IP$ imata $N_1$ in $N_2$ isti tip v razširjenem kontekstu.
		Po pravilu \rulename{TyComp-MatchSum} velja $\Gamma_1, \Gamma_3, \Gamma_2 \types M \of \tycomp{A}{\o, \i}$.
		
		\item Če je zadnje pravilo \rulename{TyComp-Signal}, potem je $M$ enak $\tmopout{op}{V}{N}$.
		Po lemi~\ref{lem:weakening-values} ima $V$ isti tip v razširjenem kontekstu.
		Po $IP$ ima $N$ isti tip v razširjenem kontekstu.
		Po pravilu \rulename{TyComp-Signal} velja $\Gamma_1, \Gamma_3, \Gamma_2 \types M \of \tycomp{A}{\o, \i}$.
		
		\item Če je zadnje pravilo \rulename{TyComp-Interrupt}, potem je $M$ enak $\tmopin{op}{V}{N}$.
		Po lemi~\ref{lem:weakening-values} ima $V$ isti tip v razširjenem kontekstu.
		Po $IP$ ima $N$ isti tip v razširjenem kontekstu.
		Po pravilu \rulename{TyComp-Interrupt} velja $\Gamma_1, \Gamma_3, \Gamma_2 \types M \of \tycomp{A}{\o, \i}$.
		
		\item Če je zadnje pravilo \rulename{TyComp-Promise}, potem je $M$ enak $\tmwith{op}{x}{N_1}{p}{N_2}$.
		Po $IP$ imata $N_1$ in $N_2$ isti tip v razširjenem kontekstu.
		Po pravilu \rulename{TyComp-Promise} velja $\Gamma_1, \Gamma_3, \Gamma_2 \types M \of \tycomp{A}{\o, \i}$.
		
		\item Če je zadnje pravilo \rulename{TyComp-Await}, potem je $M$ enak $\tmawait{V}{y}{N}$.
		Po lemi~\ref{lem:weakening-values} ima $V$ isti tip v razširjenem kontekstu.
		Po $IP$ ima $N$ isti tip v razširjenem kontekstu.
		Po pravilu \rulename{TyComp-Await} velja $\Gamma_1, \Gamma_3, \Gamma_2 \types M \of \tycomp{A}{\o, \i}$.
		
		\item Če je zadnje pravilo \rulename{TyComp-Subsume}, ima po $IP$ $M$ isti tip v razširjenem kontekstu.
		
	\end{itemize}
\end{proof}

\begin{lema}\label{lem:inversion-lema}
	Naj za izračun $M$ velja $\Gamma \types M \of \tycomp{A}{\o, \i}$.
	\begin{itemize}
		\item Če je $M$ oblike $\tmapp{V}{W}$, potem velja $\Gamma \types V \of \tyfun{B}{\tycomp{A}{\o', \i'}}$ in $\Gamma \types W \of B$.
		
		\item Če je $M$ oblike $\tmlet{x}{N_1}{N_2}$, potem velja $\Gamma \types N_1 \of \tycomp{B}{\o', \i'}$, $\Gamma \types N_2 \of \tycomp{A}{\o', \i'}$.
	
		\item Če je $M$ oblike $\tmmatch{\tmpair{V_1}{W_2}}{N}$, potem velja $\Gamma \types V_1 \of B_1$, $\Gamma \types V_2 \of B_2$ in $\Gamma \types N \of \tycomp{A}{\o', \i'}$.
		
		\item Če je $M$ oblike $\tmmatch{(\tminl[Y]{V_1})}{\tminl{x} \mapsto N_1, \tminr{y} \mapsto N_2}$, potem velja $\Gamma \types \tminl[Y]{V_1} \of B_1$, $\Gamma \types N_1 \of \tycomp{A}{\o', \i'}$ in $\Gamma \types N_2 \of \tycomp{A}{\o', \i'}$.
		
		\item Če je $M$ oblike $\tmmatch{(\tminr[X]{V_2})}{\tminl{x} \mapsto N_1, \tminr{y} \mapsto N_2}$, potem velja $\Gamma \types \tminl[X]{V_2} \of B_1$, $\Gamma \types N_1 \of \tycomp{A}{\o', \i'}$ in $\Gamma \types N_2 \of \tycomp{A}{\o', \i'}$.
		
		\item Če je $M$ oblike $\tmopout{op}{V}{N}$, potem velja $\Gamma \types V \of B$ in $\Gamma \types N \of \tycomp{A}{\o', \i'}$.
		
		\item Če je $M$ oblike $\tmopin{op}{V}{N}$, potem velja $\Gamma \types V \of B$, $\Gamma \types N \of \tycomp{A}{\o'', \i''}$ in $\opincomp{op}{(\o'', \i'')} \order (\o, \i)$.
		
		\item Če je $M$ oblike $\tmwith{op}{x}{N_1}{p}{N_2}$, potem velja $\Gamma, x \of B_{op} \types N_1 \of \tycomp{\typromise{B}}{\o'', \i''}$ in $\Gamma, p \of \typromise{B} \types N_1 \of \tycomp{A}{\o', \i'}$.
		
	\end{itemize}
	Kjer je $(\o', \i') \order{O, I} (\o, \i)$.
\end{lema}

\begin{trditev}[o ohranitvi]\label{trd:ohranitev-izracuni}
	Naj za izračun $M$ velja $\Gamma \types M \of \tycomp{A}{\o, \i}$. Če izračun $M$ naredi korak $M \reduces M'$, potem velja $\Gamma \types M' \of \tycomp{A}{\o, \i}$.
\end{trditev}

\jR{In promise(let) be careful that context change and you need to use weakening lemma. You dont have p anymore.}

\jR{inversion lemma. zavedaj se da imamo subsuption rule. Morda nimap A imaš pa A' < A.
v naslednjem dokazu dokazuješ na koraj. Ne na tip. kar pomeni da se lahko umes prikradejo subsumpiton.}

\begin{proof}
	Dokazujemo z strukturno indukcijo na drevo izpeljave koraka $M \reduces M'$.
	Ločimo primere glede na zadnje uporabljeno pravilo.
	
	\begin{itemize}
		\item Če je zadnje pravilo $$\tmapp{(\tmfun{x : B}{N})}{V} \reduces N[V/x],$$ potem ima po lemi~\ref{lem:inversion-lema} funkcija $\tmfun{x : B}{N}$ tip $\tyfun{B}{\tycomp{A}{\o', \i'}}$ in $V$ tip $B$. Posledično ima $N$ tip $\tycomp{A}{\o', \i'}$. Po lemi~\ref{lem:substitucija-izračuni} ima $M' = N[V/x]$ tip $\tycomp{A}{\o', \i'}$.
		Po pravilu \rulename{TyComp-Subsume} ima $M'$ tip $\tycomp{A}{\o, \i}$.
		
		\item Če je zadnje pravilo $$\tmapp{(\tmfunrec{f}{x \of A'}{N})}{V} \reduces N[V/x, (\tmfunrec{f}{x \of A'}{N})/f],$$ potem ima po lemi~\ref{lem:inversion-lema} funkcija $\tmfunrec{f}{x \of B}{N}$ tip $\tyfun{B}{\tycomp{A}{\o', \i'}}$ in $V$ tip $B$. Posledično ima $N$ tip $\tycomp{A}{\o', \i'}$. Po lemi~\ref{lem:substitucija-izračuni} ima $\widetilde{M} = N[V/x]$ tip $\tycomp{A}{\o', \i'}$ in po isti lemi ima $M' = \widetilde{M}[(\tmfunrec{f}{x \of B}{N})/f]$ tip $\tycomp{A}{\o', \i'}$.
		Po pravilu \rulename{TyComp-Subsume} ima $M'$ tip $\tycomp{A}{\o, \i}$.
		
		\item Če je zadnje pravilo $$\tmlet{x}{(\tmreturn V)}{N} \reduces N[V/x],$$ potem ima po lemi~\ref{lem:inversion-lema} vrednost $V$ tip $B$ in $N$ tip $\tycomp{A}{\o', \i'}$.
		Po lemi~\ref{lem:substitucija-izračuni} ima $M' = N[V/x]$ tip $\tycomp{A}{\o', \i'}$.
		Po pravilu \rulename{TyComp-Subsume} ima $M'$ tip $\tycomp{A}{\o, \i}$.
		
		\item Če je zadnje pravilo $$\tmmatch{\tmpair{V}{W}}{\tmpair{x}{y} \mapsto N} \reduces N[V/x, W/y],$$ potem ima po lemi~\ref{lem:inversion-lema} vrednost $\tmpair{V}{W}$ tip $B_1 \times B_2$, $V$ tip $B_1$, $W$ tip $B_2$ in $N$ tip $\tycomp{A}{\o', \i'}$. Po lemi~\ref{lem:substitucija-izračuni} ima $\widetilde{M} = N[V/x]$ tip $\tycomp{A}{\o', \i'}$ in po isti lemi ima $M' = \widetilde{M}[W/y]$ tip $\tycomp{A}{\o', \i'}$.
		Po pravilu \rulename{TyComp-Subsume} ima $M'$ tip $\tycomp{A}{\o, \i}$.
		
		\item Če je zadnje pravilo $$\tmmatch{(\tminl[Y]{V})}{\tminl{x} \mapsto N_1, \tminr{y} \mapsto N_2} \reduces N_1[V/x],$$ potem ima po lemi~\ref{lem:inversion-lema} vrednost $\tminl{V}$ tip $B_1 + B_2$, $V$ tip $B_1$ in $N_1$ tip $\tycomp{A}{\o', \i'}$.
		Po lemi~\ref{lem:substitucija-izračuni} ima $M' = N_1[V/x]$ tip $\tycomp{A}{\o', \i'}$.
		Po pravilu \rulename{TyComp-Subsume} ima $M'$ tip $\tycomp{A}{\o, \i}$.
		
		\item Če je zadnje pravilo $$\tmmatch{(\tminr[X]{W})}{\tminl{x} \mapsto N_1, \tminr{y} \mapsto N_2} \reduces N_2[W/y],$$ potem ima po lemi~\ref{lem:inversion-lema} vrednost $\tminr{W}$ tip $B_1 + B_2$, $W$ tip $B_2$ in $N_2$ tip $\tycomp{A}{\o', \i'}$.
		Po lemi~\ref{lem:substitucija-izračuni} ima $M' = N_2[W/y]$ tip $\tycomp{A}{\o', \i'}$.
		Po pravilu \rulename{TyComp-Subsume} ima $M'$ tip $\tycomp{A}{\o, \i}$.
		
		\item Če je zadnje pravilo $$\tmlet{x}{(\tmopout{op}{V}{N_1})}{N_2} \reduces \tmopout{op}{V}{\tmlet{x}{M}{N}},$$ potem ima po lemi~\ref{lem:inversion-lema} vrednost $V$ tip $B_{op}$, $\tmopout{op}{V}{N_1}$ tip $\tycomp{B}{\o, \i}$, $N_1$ tip $\tycomp{B}{\o'', \i''}$ in $N_2$ tip $\tycomp{A}{\o', \i'}$, kjer je $(\o'', \i'') \order{O, I} (\o', \i')$.
		Po pravilih \rulename{TyComp-Let} in \rulename{TyComp-Signal} ima $M'$ tip $\tycomp{A}{\o', \i'}$.
		Po pravilu \rulename{TyComp-Subsume} ima $M'$ tip $\tycomp{A}{\o, \i}$.
		
		\item Če je zadnje pravilo $$\tmlet{x}{(\tmwith{op}{y}{N_1}{p}{N_2})}{N_3} \reduces \tmwith{op}{y}{N_1}{p}{(\tmlet{x}{N_2}{N_3})},$$ potem ima po lemi~\ref{lem:inversion-lema} izračun $N_1$ tip $\tycomp{\typromise{A_1}}{\o''', \i'''}$, $N_2$ tip $\tycomp{A_2}{\o'', \i''}$ in $N_3$ tip $\tycomp{A}{\o', \i'}$.
		Po lemi~\ref{lem:weakening-comp} ima $N_3$ isti tip tudi kontekstu razširjenem z $p$. \jR{Tu najbrž manjka da je $p$ sveža spremenljivka?}
		Po pravilih \rulename{TyComp-Let} in \rulename{TyComp-Promise} ima $M'$ tip $\tycomp{A}{\o', \i'}$.
		Po pravilu \rulename{TyComp-Subsume} ima $M'$ tip $\tycomp{A}{\o, \i}$.
		
		\item Če je zadnje pravilo $$\tmwith{op}{x}{N_1}{p}{\tmopout{op'}{V}{N_2}} \reduces \tmopout{op'}{V}{\tmwith{op}{x}{N_1}{p}{N_2}},$$ potem ima po lemi~\ref{lem:inversion-lema} izračun $N_1$ tip $\tycomp{B}{\o''', \i'''}$, $\tmopout{op'}{V}{N_2}$ tip $\tycomp{A}{\o'', \i''}$, $N_2$ tip $\tycomp{A}{\o', \i'}$ in $V$ tip $A_{op}$.
		Po pravilih \rulename{TyComp-promise} ima $\tmwith{op}{x}{N_1}{p}{N_2}$ tip $\tycomp{A}{\o', \i'}$.
		Po lemi~\ref{lem:tovor-osnovni-tip-skrcitev} ima $V$ še zmeraj tip $A_{op}$ tudi v manjšem kontekstu. Po pravilu \rulename{TyComp-Signal} ima $M'$ tip $\tycomp{A}{\o', \i'}$.
		Po pravilu \rulename{TyComp-Subsume} ima $M'$ tip $\tycomp{A}{\o, \i}$.
		
		\item Če je zadnje pravilo $$\tmopin{op}{V}{\tmopout{op'}{W}{N}} \reduces \tmopout{op'}{W}{\tmopin{op}{V}{N}},$$ potem ima po lemi~\ref{lem:inversion-lema} vrednost $V$ tip $A_{op}$, $W$ tip $A_{op'}$ in $N$ tip $\tycomp{A}{\o', \i'}$.
		Po pravilu \rulename{TyComp-Signal} in \rulename{TyComp-Interrupt} ima $M'$ tip $\tycomp{A}{\o', \i'}$.
		Po pravilu \rulename{TyComp-Subsume} ima $M'$ tip $\tycomp{A}{\o, \i}$.
		
		\item Če je zadnje pravilo $$\tmopin{op}{V}{\tmreturn W} \reduces \tmreturn W,$$ potem ima po lemi~\ref{lem:inversion-lema} izračun $\tmreturn{W}$ tip $\tycomp{A}{\o', \i'}$.
		Po pravilu \rulename{TyComp-Subsume} ima $M'$ tip $\tycomp{A}{\o, \i}$.
		
		\item Če je zadnje pravilo $$\tmopin{op}{V}{\tmwith{op}{x}{N_1}{p}{N_2}} \reduces \tmlet{p}{N_1[V/x]}{\tmopin{op}{V}{N_2}},$$ potem ima po lemi~\ref{lem:inversion-lema} vrednost $V$ tip $A_{op}$, $N_1$ tip $\tycomp{\typromise{B}}{\o'', \i''}$ in $N_2$ tip $\tycomp{A}{\o', \i'}$.
		Po lemi~\ref{lem:substitucija-izračuni} ima $N_1[V/x]$ tip $\tycomp{\typromise{B}}{\o'', \i''}$.
		Po pravilu \rulename{TyComp-Interrupt} ima $\tmopin{op}{V}{N_2}$ tip $\tycomp{A}{\opincomp{op}{(\o', \i')}}$
		Ker velja $\i(op) = (\o'', \i'')$, velja $(\o'', \i'') \order{O \times I} \opincomp{op}{(\o', \i')}$ in posledično ima po pravilu \rulename{TyComp-Subsume} izračun $N_1[V/x]$ tip $\tycomp{\typromise{B}}{\opincomp{op}{(\o', \i')}}$
		Po pravilu \rulename{TyComp-Let} ima $M'$ tip $\tycomp{A}{\opincomp{op}{(\o', \i')}}$.
		Po pravilu \rulename{TyComp-Subsume} ima $M'$ tip $\tycomp{A}{\o, \i}$.
		
		\item Če je zadnje pravilo $$\tmopin{op'}{V}{\tmwith{op}{x}{N_1}{p}{N_2}} \reduces \tmwith{op}{x}{N_1}{p}{\tmopin{op'}{V}{N}_2},$$ potem ima po lemi~\ref{lem:inversion-lema} vrednost $V$ tip $A_{op}$, $N_1$ tip $\tycomp{\typromise{B}}{\o'', \i''}$ in $N_2$ tip $\tycomp{A}{\o', \i'}$.
		Po lemi~\ref{lem:weakening-values}, ima $V$ isti tip tudi v kontekstu razširjenem z $p$. \jR{Tu najbrž manjka da je $p$ sveža spremenljivka?}
		Po pravilu \rulename{TyComp-Interrupt} ima $\tmopin{op'}{V}{N}_2$ tip $\tycomp{A}{\opincomp{op}{(\o', \i')}}$.
		Po pravilu \rulename{TyComp-Promise} ima $M'$ tip $\tycomp{A}{\opincomp{op}{(\o', \i')}}$.
		Po pravilu \rulename{TyComp-Subsume} ima $M'$ tip $\tycomp{A}{\o, \i}$.
		
		\item Če je zadnje pravilo $$\tmawait{\tmpromise V}{x}{N} \reduces N[V/x],$$ potem ima po lemi~\ref{lem:inversion-lema} vrednost $\tmpromise{V}$ tip $\typromise{B}$, $V$ tip $B$ in $N$ tip $\tycomp{A}{\o', \i'}$.
		Po lemi~\ref{lem:substitucija-izračuni} ima $M'$ tip $\tycomp{A}{\o', \i'}$.
		Po pravilu \rulename{TyComp-Subsume} ima $M'$ tip $\tycomp{A}{\o, \i}$.
		
		
		
		
		\item Če je zadnje pravilo $$\coopinfer{}{
			N \reduces N'
		}{
			M[N] \reduces M[N']
		},$$
		ločimo primere glede na obliko $M[N]$.
		\begin{itemize}
			\item Če je oblike $$\tmlet{x}{N}{N''},$$ potem ima po lemi~\ref{lem:inversion-lema} izračun $N$ tip $\tycomp{B}{\o', \i'}$ in $N''$ tip $\tycomp{A}{\o'', \i''}$.
			Po $IP$ ima $N'$ tip $\tycomp{B}{\o', \i'}$.
			Po pravilu \rulename{TyComp-Subsume} ima $N'$ tip $\tycomp{A}{\o, \i}$.
			Po pravilu \rulename{TyComp-Subsume} ima $N''$ tip $\tycomp{A}{\o, \i}$.
			Po pravilu \rulename{TyComp-Let} ima $\tmlet{x}{N'}{N''}$ tip $\tycomp{A}{\o, \i}$.
			
			\item Če je oblike $$\tmopout{op}{V}{N},$$ potem ima po lemi~\ref{lem:inversion-lema} izračun $N$ tip $\tycomp{A}{\o', \i'}$.
			Po $IP$ ima $N'$ tip $\tycomp{A}{\o', \i'}$.
			Po pravilu \rulename{TyComp-Signal} ima $\tmopout{op}{V}{N'}$ tip $\tycomp{A}{\o', \i'}$.
			Po pravilu \rulename{TyComp-Subsume} ima $M'$ tip $\tycomp{A}{\o, \i}$.
			
			\item Če je oblike $$\tmopin{op}{V}{N},$$ potem ima po lemi~\ref{lem:inversion-lema} izračun $N$ tip $\tycomp{A}{\o', \i'}$.
			Po $IP$ ima $N'$ tip $\tycomp{A}{\o', \i'}$.
			Po pravilu \rulename{TyComp-Interrupt} ima $\tmopin{op}{V}{N'}$ tip $\tycomp{A}{\o', \i'}$.
			Po pravilu \rulename{TyComp-Subsume} ima $M'$ tip $\tycomp{A}{\o, \i}$.
			
			\item Če je oblike $$\tmwith{op}{x}{N''}{N},$$ potem ima po lemi~\ref{lem:inversion-lema} izračun $N$ tip $\tycomp{A}{\o', \i'}$ in $N''$ tip $\tycomp{\typromise{B}}{\o'', \i''}$.
			Po $IP$ ima $N'$ tip $\tycomp{A}{\o', \i'}$.
			Po pravilu \rulename{TyComp-promise} ima $\tmwith{op}{x}{N''}{N'}$ tip $\tycomp{A}{\o', \i'}$.
			Po pravilu \rulename{TyComp-Subsume} ima $M'$ tip $\tycomp{A}{\o, \i}$.
		\end{itemize}

	\end{itemize}

\end{proof}


Ko imamo par procesov in eden izmed njiju pošlje signal, se bo ta signal spremenil v prekinitev na drugem procesu. 
Le to bo povzročilo, da se bo tip efektov spremenil na drugem procesu.
Potencialno spremembo tipa formaliziramo z pravili za redukcijo tipov, ki jih lahko vidimo na sliki~\ref{fig:process-type-reductions}.

\begin{figure}[H]
	\centering
	\begin{mathpar}
		\coopinfer{TyRedu-Same}{
		}{
			\tyrun{A}{\o, \i} \tyreduces \tyrun{A}{\o, \i}
		}
		\quad
		\coopinfer{TyRedu-Change}{
		}{
			\tyrun{A}{\o, \i} \tyreduces \tyrun{A}{\opincomp{op}{(\o, \i)}}
		}
		\\
		\coopinfer{TyRedu-Par}{
			C \tyreduces C' \\
			D \tyreduces D'
		}{
			\typar{C}{D} \tyreduces \typar{C'}{D'}
		}
	\end{mathpar}
	\caption{Pravila za redukcijo tipov.}
	\label{fig:process-type-reductions}
	
\end{figure}



\begin{izrek}[o ohranitvi]
	Naj za proces $P$ velja $\Gamma \types P \of C$. Če proces $P$ naredi korak $P \reduces P'$, potem obstaja tak $C'$, da velja $C \tyreduces C'$ in $\Gamma \types P' \of C'$.
\end{izrek}

\begin{proof}
	Dokazujemo z strukturno indukcijo na drevo izpeljave koraka $P \reduces P'$.
	Ločimo primere glede na zadnje uporabljeno pravilo.
	
	\begin{itemize}
		\item Če je zadnje uporabljeno pravilo
		$$
		\coopinfer{}{
			M \reduces N
		}{
			\tmrun M \reduces \tmrun N
		},$$
		potem je bilo zadnje pravilo za določitev tipa $P$ \rulename{TyProc-Run}. Tip $C$ je oblike $\tyrun{A}{\o, \i}$.
		Posledično ima izračun $M$ tip $\tycomp{A}{\o, \i}$. Po trditvi~\ref{trd:ohranitev-izracuni} ima $N$ tip $\tycomp{A}{\o, \i}$.
		Po pravilu \rulename{TyProc-Run} ima $P'$ tip $\tyrun{A}{\o, \i}$, kjer je $C$ naredil korak \rulename{TyRedu-Same}.
	
		\item Če je zadnje uporabljeno pravilo
		$$\tmrun {(\tmopout{op}{V}{M})}  \reduces \tmopout{op}{V}{\tmrun M},$$
		potem je bilo zadnje pravilo za določitev tipa $P$ \rulename{TyProc-Run}. Tip $C$ je oblike $\tyrun{A}{\o, \i}$.
		Posledično ima $V$ tip $B$ in $M$ tip $\tycomp{A}{\o, \i}$.
		Po pravilu \rulename{TyProc-Run} ima $\tmrun{M}$ tip $\tyrun{A}{\o, \i}$.
		Po pravilu \rulename{TyProc-Signal} ima $P'$ tip $\tyrun{A}{\o, \i}$, kjer je $C$ naredil korak \rulename{TyRedu-Same}.
		
		\item Če je zadnje uporabljeno pravilo
		$$\tmopin{op}{V}{\tmrun M} \reduces \tmrun {(\tmopin{op}{V}{M})},$$
		potem je bilo zadnje pravilo za določitev tipa $P$ \rulename{TyProc-Interrupt}. Tip $C$ je oblike $\tyrun{A}{\o, \i}$.
		Posledično ima $V$ tip $B$ in $M$ tip $\tycomp{A}{\o, \i}$.
		Po pravilu \rulename{TyComp-Interrupt} ima $\tmopin{op}{V}{M}$ tip $\tycomp{A}{\o, \i}$.
		Po pravilu \rulename{TyProc-Run} ima $P'$ tip $\tyrun{A}{\o, \i}$, kjer je $C$ naredil korak \rulename{TyRedu-Same}.
		
		\item Če je zadnje uporabljeno pravilo
		$$\tmpar{\tmopout{op}{V}{Q_1}}{Q_2} \reduces \tmopout{op}{V}{\tmpar{Q_1}{\tmopin{op}{V}{Q_2}}},$$
		potem je bilo zadnje pravilo za določitev tipa $P$ \rulename{TyProc-Par}. Tip $C$ je oblike $\typar{C_1}{C_2}$.
		Posledično ima $V$ tip $B$, $Q_1$ tip $C_1$ in $Q_2$ tip $C_2$.
		Po pravilu \rulename{TyComp-Interrupt} ima $\tmopin{op}{V}{Q_2}$ tip $\opincomp{op}{C_2}$.
		Po pravilu \rulename{TyProc-Par} ima $P'$ tip $\typar{C_1}{\opincomp{op}{C_2}}$, kjer je $C_2$ naredil korak \rulename{TyRedu-Change} in $C$ naredil korak \rulename{TyRedu-Par}.

		\item Če je zadnje uporabljeno pravilo
		$$\tmpar{Q_1}{\tmopout{op}{V}{Q_2}} \reduces \tmopout{op}{V}{\tmpar{\tmopin{op}{V}{Q_1}}{Q_2}},$$
		potem je bilo zadnje pravilo za določitev tipa $P$ \rulename{TyProc-Par}. Tip $C$ je oblike $\typar{C_1}{C_2}$.
		Posledično ima $V$ tip $B$, $Q_1$ tip $C_1$ in $Q_2$ tip $C_2$.
		Po pravilu \rulename{TyComp-Interrupt} ima $\tmopin{op}{V}{Q_1}$ tip $\opincomp{op}{C_1}$.
		Po pravilu \rulename{TyProc-Par} ima $P'$ tip $\typar{\opincomp{op}{C_1}}{C_2}$, kjer je $C_1$ naredil korak \rulename{TyRedu-Change} in $C$ naredil korak \rulename{TyRedu-Par}.
	
		\item Če je zadnje uporabljeno pravilo
		$$\tmopin{op}{V}{\tmpar{Q_1}{Q_2}} \reduces \tmpar {\tmopin{op}{V}{Q_1}} {\tmopin{op}{V}{Q_2}},$$
		potem je bilo zadnje pravilo za določitev tipa $P$ \rulename{TyProc-Interrupt}.
		Posledično ima $V$ tip $B$, $Q_1$ tip $C_1$ in $Q_2$ tip $C_2$.
		Po pravilu \rulename{TyComp-Interrupt} ima $\tmopin{op}{V}{Q_1}$ tip $\opincomp{op}{C_1}$ in $\tmopin{op}{V}{Q_2}$ tip $\opincomp{op}{C_2}$.
		Po pravilu \rulename{TyProc-Par} ima $P'$ tip $\typar{\opincomp{op}{C_1}}{\opincomp{op}{C_2}}$, kjer sta $C_1$ in $C_2$ naredila korak \rulename{TyRedu-Change} in $C$ naredil korak \rulename{TyRedu-Par}.
		
		\item Če je zadnje uporabljeno pravilo
		$$\tmopin{op}{V}{\tmopout{op'}{W}{Q}} \reduces \tmopout{op'}{V'}{\tmopin{op}{V}{Q}},$$
		potem je bilo zadnje pravilo za določitev tipa $P$ \rulename{TyProc-Interrupt}. Tip $C$ je oblike $\opincomp{op}{C'}$
		Posledično ima $V$ tip $B$, $V'$ tip $B'$ in $Q$ tip $C'$.
		Po pravilu \rulename{TyComp-Interrupt} ima $\tmopin{op}{V}{Q}$ tip $C$.
		Po pravilu \rulename{TyProc-Signal} ima $P'$ tip $C$, kjer je $C$ naredil korak \rulename{TyRedu-Same}.
		
		\item Če je zadnje uporabljeno pravilo
		$$\coopinfer{}{
						Q \reduces Q'
					}{
						P[Q] \reduces P[Q']
					},$$
		ločimo primere glede na obliko $P[Q]$.
		\begin{itemize}
			\item Če je oblike $$\tmpar{Q}{Q''},$$ potem je bilo zadnje pravilo za določitev tipa $P[Q]$ \rulename{TyProc-Par}. Tip $C$ je oblike $\typar{C_1}{C_2}$.
			Posledično ima $Q$ tip $C_1$ in $Q''$ tip $C_2$.
			Po $IP$ ima $Q'$ tip $C_1'$.
			Po pravilu \rulename{TyProc-Par} ima $\tmpar{Q'}{Q''}$ tip $\typar{C_1'}{C_2}$, kjer je $C$ naredil korak \rulename{TyRedu-Par}.
			
			\item Če je oblike $$\tmpar{Q''}{Q},$$ potem je bilo zadnje pravilo za določitev tipa $P[Q]$ \rulename{TyProc-Par}. Tip $C$ je oblike $\typar{C_1}{C_2}$.
			Posledično ima $Q''$ tip $C_1$ in $Q$ tip $C_2$.
			Po $IP$ ima $Q'$ tip $C_2'$.
			Po pravilu \rulename{TyProc-Par} ima $\tmpar{Q''}{Q'}$ tip $\typar{C_1}{C_2'}$, kjer je $C$ naredil korak \rulename{TyRedu-Par}.
			
			\item Če je oblike $$\tmopout{op}{V}{Q},$$ potem je bilo zadnje pravilo za določitev tipa $P[Q]$ \rulename{TyProc-Signal}.
			Posledično ima $V$ tip $B$ in $Q$ tip $C$.
			Po $IP$ ima $Q'$ tip $C'$.
			Po pravilu \rulename{TyProc-Signal} ima $\tmopout{op}{V}{Q'}$ tip $C'$, kjer je $C$ naredil korak \rulename{TyRedu-Change}.
			
			\item Če je oblike $$\tmopin{op}{V}{Q},$$ potem je bilo zadnje pravilo za določitev tipa $P[Q]$ \rulename{TyProc-Interrupt}.
			Posledično ima $V$ tip $B$ in $Q$ tip $C$.
			Po $IP$ ima $Q'$ tip $C'$.
			Po pravilu \rulename{TyProc-Interrupt} ima $\tmopin{op}{V}{Q'}$ tip $C'$, kjer je $C$ naredil korak \rulename{TyRedu-Change}.
		\end{itemize}
	
	\end{itemize}

\end{proof}


